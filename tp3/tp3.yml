---
- name: Installe et configure les softs sur les machines cibles
  hosts: all
  tasks:

    - name: Installe les softs sur les machines web (Ubuntu 22.04)
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
        update_cache: yes
      loop:
        - apache2
        - mysql-server
      when: ansible_os_family == 'Ubuntu'

    - name: Installe les paquets pour la machine de dev
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
        update_cache: yes
      loop:
        - git
        - nginx
        - cowsay
      when: ansible_os_family == 'Debian'

    - name: Installe les softs sur les machines web (Ubuntu 22.04)
      ansible.builtin.apt:
        name: ufw
        state: present
      when: ansible_os_family == 'Ubuntu'

    - name: Gather the rpm package facts
      ansible.builtin.package_facts:
        manager: auto

    - name: Copy index.html if apache2 or nginx is installed
      ansible.builtin.template:
        src: template/index.j2
        dest: /var/www/html/index.html
        mode: '0644'
      when: "'apache2' in ansible_facts.packages or 'nginx' in ansible_facts.packages"

    - name: Start apache2
      ansible.builtin.service:
        name: apache2
        state: started
      when: "'apache2' in ansible_facts.packages"

    - name: Start nginx
      ansible.builtin.service:
        name: nginx
        state: started
      when: "'nginx' in ansible_facts.packages"    

    - name: Ecrit dans /etc/jour selon le jour et l'heure
      ansible.builtin.copy:
        dest: /etc/jour
        content: "pair et plus tard que midi"
      when:
        - ansible_date_time.day | int % 2 == 0  # Jour pair
        - ansible_date_time.hour | int >= 12    # Plus de 12h00

    - name: Ecrit "pair et avant midi" dans /etc/jour si conditions remplies
      ansible.builtin.copy:
        dest: /etc/jour
        content: "pair et avant midi"
      when:
        - ansible_date_time.day | int % 2 == 0  # Jour pair
        - ansible_date_time.hour | int < 12     # Moins de 12h00

    - name: Ecrit "impair et plus tard que midi" dans /etc/jour si conditions remplies
      ansible.builtin.copy:
        dest: /etc/jour
        content: "impair et plus tard que midi"
      when:
        - ansible_date_time.day | int % 2 != 0  # Jour impair
        - ansible_date_time.hour | int >= 12    # Plus de 12h00

    - name: Ã‰crire "impair et avant midi" dans /etc/jour si conditions remplies
      ansible.builtin.copy:
        dest: /etc/jour
        content: "impair et avant midi"
      when:
        - ansible_date_time.day | int % 2 != 0
        - ansible_date_time.hour | int < 12
